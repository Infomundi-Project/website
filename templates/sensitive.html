{% extends "base.html" %}{% block title %}Sensitive Page{% endblock %}
{% block content %}
<div class="container col-xl-10 col-xxl-8 px-4 py-2">
  <div class="row align-items-center g-lg-5 py-5">
    <div class="col-lg-7 text-center text-lg-start {% if is_mobile %}mb-3{% endif %}">
      <h1 class="display-4 fw-bold lh-1 text-body-emphasis mb-3">Sensitive Page</h1>
      <h2 class="col-lg-10 fs-5">Hey, {{ current_user.username }}. Looks like you've found a sensitive page, that may allow strangers to change vital settings in your Infomundi account. Please, for your safety, prove that you are indeed who you say you are. <br><br>If you encounter any issues, please don't hesitate to <a href="{{ url_for('views.contact') }}">contact our team</a> for assistance.</h2>
    </div>
    <div class="col-md-10 mx-auto col-lg-5">
      <form class="p-4 p-md-5 border rounded-3 bg-body-tertiary needs-validation" novalidate method="post" action="{{ url_for('views.sensitive') }}">
        <span class="badge d-inline-flex align-items-center p-1 text-primary-emphasis bg-primary-subtle border border-primary-subtle rounded-pill mb-3">
        <img class="rounded-circle me-1" width="24" height="24" src="{{ current_user.avatar_url }}" alt="{{ current_user.username }}'s profile picture">
        {% if not is_mobile %}Logged in as{% endif %}<span class="ms-1 notranslate">{{ current_user.username }}</span>
        <span class="vr mx-2"></span>
        <a data-bs-toggle="modal" data-bs-target="#signOutModal">
        <i class="fa-solid fa-right-from-bracket me-1"></i>{% if not is_mobile %}Sign out{% endif %}
        </a>
        </span>
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        {% if current_user.totp_secret %}
        <!-- TOTP Input Group -->
        <div id="totp-input-group">
          <div class="input-group">
            <span class="input-group-text"><i class="fa-solid fa-clock"></i></span>
            <div class="form-floating">
              <input name="code" type="text" class="form-control" id="floatingInputCurrentTOTP" placeholder="TOTP" maxlength="6" minlength="6" required>
              <label for="floatingInputCurrentTOTP">Code</label>
            </div>
          </div>
        </div>
        <!-- Recovery Token Input Group (Initially Hidden) -->
        <div id="recovery-token-input-group" style="display: none;">
          <div class="input-group">
            <span class="input-group-text"><i class="fa-solid fa-key"></i></span>
            <div class="form-floating">
              <input name="recovery_token" type="text" class="form-control" id="floatingInputRecoveryToken" placeholder="Recovery Token">
              <label for="floatingInputRecoveryToken">Recovery Token</label>
            </div>
          </div>
        </div>
        {% elif current_user.is_mail_twofactor_enabled %}
        <!-- Email 2FA Send Button -->
        <div class="mb-3">
          <button type="button" id="send-email-2fa" class="btn btn-outline-primary w-100">
            Send code to my email
          </button>
          <small id="email-timer" class="text-muted ms-2"></small>
        </div>
        <!-- Email Code Input Group -->
        <div id="email-input-group">
          <div class="input-group">
            <span class="input-group-text"><i class="fa-solid fa-envelope"></i></span>
            <div class="form-floating">
              <input name="code" type="text" class="form-control" id="floatingInputEmailCode" placeholder="Code" maxlength="6" minlength="6" required>
              <label for="floatingInputEmailCode">Code</label>
            </div>
          </div>
        </div>
        <!-- Recovery Token Input Group (Initially Hidden) -->
        <div id="recovery-token-input-group" style="display: none;">
          <div class="input-group">
            <span class="input-group-text"><i class="fa-solid fa-key"></i></span>
            <div class="form-floating">
              <input name="recovery_token" type="text" class="form-control" id="floatingInputRecoveryToken" placeholder="Recovery Token">
              <label for="floatingInputRecoveryToken">Recovery Token</label>
            </div>
          </div>
        </div>
        {% else %}
        <div class="input-group">
          <div class="form-floating flex-grow-1">
            <input type="password" class="form-control" id="floatInputCurrentPassword" placeholder="Current Password" name="password" maxlength="50" minlength="8" required>
            <label for="floatInputCurrentPassword">Current Password</label>
            <div class="invalid-feedback">
              Please provide a password with 8 to 50 characters.
            </div>
          </div>
          <span class="input-group-text password-toggle" id="floatInputCurrentPasswordIcon">
          <i class="fa-solid fa-eye" data-toggle="floatInputCurrentPassword"></i>
          </span>
        </div>
        {% endif %}
        <div class="checkbox my-2">
          <label>
          <input type="checkbox" value="yes" name="trust_session" class="me-1">Trust this session
          </label>
        </div>
    <button class="btn btn-primary w-100" type="submit" id="captchaSubmitButton">Submit</button>
    {% if current_user.totp_secret or current_user.is_mail_twofactor_enabled %}
    <hr class="my-4">
    <small class="text-muted">
    <a href="#" id="toggle-device-link" class="text-decoration-none">I don't have access to my two factor device</a>.
    </small>
    {% endif %}
    </form>
  </div>
</div>
</div>
{% endblock %}
{% block scripts %}
{% if current_user.totp_secret %}
<script nonce="{{ nonce }}"
  src="{{ url_for('static', filename='js/codeTokenChanger.js') }}"
  ></script>
{% elif current_user.is_mail_twofactor_enabled %}
<script nonce="{{ nonce }}">
  document.addEventListener('DOMContentLoaded', function () {
    // Toggle between email code and recovery token
    const toggleDeviceLink = document.getElementById('toggle-device-link');
    const emailInputGroup = document.getElementById('email-input-group');
    const recoveryTokenInputGroup = document.getElementById('recovery-token-input-group');

    toggleDeviceLink.addEventListener('click', function (event) {
      event.preventDefault();

      if (emailInputGroup.style.display === 'none') {
        // Show email input, hide recovery token
        emailInputGroup.style.display = 'block';
        recoveryTokenInputGroup.style.display = 'none';
        document.getElementById('floatingInputEmailCode').setAttribute('required', true);
        document.getElementById('floatingInputRecoveryToken').removeAttribute('required');
        toggleDeviceLink.textContent = "I don't have access to my two factor device";
      } else {
        // Hide email input, show recovery token
        emailInputGroup.style.display = 'none';
        recoveryTokenInputGroup.style.display = 'block';
        document.getElementById('floatingInputRecoveryToken').setAttribute('required', true);
        document.getElementById('floatingInputEmailCode').removeAttribute('required');
        toggleDeviceLink.textContent = "Nevermind, I have access to my two factor device";
      }
    });

    // Email 2FA resend button handler
    const emailBtn = document.getElementById('send-email-2fa');
    if (emailBtn) {
      const timerDisplay = document.getElementById('email-timer');
      const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
      let cooldown = 0, intervalId;

      emailBtn.addEventListener('click', () => {
        if (cooldown > 0) return;

        emailBtn.disabled = true;
        fetch('{{ url_for("api.send_mail_twofactor_code") }}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
          },
          body: JSON.stringify({}),
        })
          .then((res) => {
            if (!res.ok) throw new Error('Failed to send code');
            cooldown = 60;
            timerDisplay.textContent = ` (${cooldown}s)`;
            intervalId = setInterval(() => {
              cooldown--;
              if (cooldown <= 0) {
                clearInterval(intervalId);
                emailBtn.disabled = false;
                timerDisplay.textContent = '';
              } else {
                timerDisplay.textContent = ` (${cooldown}s)`;
              }
            }, 1000);
          })
          .catch((err) => {
            console.error(err);
            emailBtn.disabled = false;
            timerDisplay.textContent = '';
            alert('Oops! Unable to send email. Please try again.');
          });
      });
    }
  });
</script>
{% else %}
<script defer nonce="{{ nonce }}"
  src="{{ url_for('static', filename='js/passwordUtility.js') }}"
  ></script>
{% endif %}
<script nonce="{{ nonce }}"
  src="{{ url_for('static', filename='js/defaultFormValidation.js') }}"
  ></script>
{% endblock %}