{% extends "base.html" %}
{% block title %}Edit Avatar{% endblock %}
{% block header %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/libs/cropper.min.css') }}">
{% endblock %}
{% block styles %}
<style>
    .profile-background {
    background-image: url('{{ current_user.profile_wallpaper_url }}');
    width: 100%;
    height: 400px;
    border-radius: 15px;
    background-size: cover;
    background-position: center;
    position: relative;
    }
    .avatar-img {
    border-radius: 15px;
    }
    .profile-mockup {
    position: absolute;
    top: 10%;
    left: 50%;
    transform: translateX(-50%);
    width: 80%;
    height: 80%;
    border-radius: 15px;
    padding: 20px;
    color: white;
    display: flex;
    flex-direction: column;
    z-index: 2;
    }
    .profile-mockup .avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    margin-bottom: 10px;
    }
    .profile-mockup .username {
    font-size: 1.5em;
    font-weight: bold;
    margin-bottom: 5px;
    }
    .profile-mockup .description {
    font-size: 1em;
    }
    .profile-header {
    background: url('{{ current_user.profile_banner_url }}') no-repeat center center;
    background-size: cover;
    height: 200px;
    position: relative;
    border-radius: 15px 15px 15px 15px;
    overflow: hidden;
    }
    .profile-header::after {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: auto;
    background: linear-gradient(to bottom, rgba(0, 0, 0, 0.5), transparent);
    }
    .profile-avatar {
    width: 75px;
    height: auto;
    border-radius: 15px;
    border: 5px solid white;
    /*position: absolute;*/
    /*top: 160px; */
    left: 3.5vh;
    /*z-index: 3; */
    }
</style>
{% endblock %}
{% block edit_profile_content %}
<form method="POST" action="{{ url_for('views.upload_image') }}" enctype="multipart/form-data" id="captcha-wait-form">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <div>
        <h3>Background Image</h3>
        <hr>
        <div class="row">
            <div class="col-md-12 justify-content-start">
                <div id="profileBackground" class="profile-background bg-secondary">
                    <div class="profile-mockup bg-secondary-subtle opacity-78">
                        <div class="profile-header mb-3" id="profileHeader"></div>
                        <div class="row">
                            <div class="col-8">
                                <div class="row">
                                    <div class="col-2">
                                        <img src="{{ current_user.avatar_url }}" alt="User Avatar" class="profile-avatar">
                                    </div>
                                    <div class="ms-2 col">
                                        {% if current_user.display_name %}
                                        <p class="fs-6 fw-bold">{{ current_user.display_name }}</p>
                                        <p class="small text-muted">@{{ current_user.username }}</p>
                                        {% else %}
                                        <p class="fs-6 text-bold">{{ current_user.username }}</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="col-4">
                                <p class="fs-4">
                                    <span class="fw-bold me-2">Level</span><span class="badge text-bg-info">{{ current_user.level }}</span>
                                </p>
                                <span>{{ current_user.level_progress }}/1000</span>
                                <div class="progress" role="progressbar" aria-valuenow="{{ current_user.level_progress }}" aria-valuemin="0" aria-valuemax="100" style="height: 3px">
                                    <div class="progress-bar bg-info" style="width: 25%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="backgroundImage" class="form-label">Select Background Image</label>
                    <input class="form-control" type="file" id="backgroundImage" name="profile_background" accept="image/*">
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="bannerImage" class="form-label">Select Banner Image</label>
                    <input class="form-control" type="file" id="bannerImage" name="profile_banner" accept="image/*">
                </div>
            </div>
        </div>
    </div>
    <div>
        <h3>Avatar</h3>
        <hr>
        <div class="d-flex align-items-center mb-3">
            <img id="largeAvatar" src="{{ current_user.avatar_url }}" alt="Large Avatar" class="avatar-img me-3" style="width: 184px; height: 184px;">
            <img id="mediumAvatar" src="{{ current_user.avatar_url }}" alt="Medium Avatar" class="avatar-img me-3" style="width: 64px; height: 64px;">
            <img id="smallAvatar" src="{{ current_user.avatar_url }}" alt="Small Avatar" class="avatar-img" style="width: 32px; height: 32px;">
        </div>
        <div class="mb-3">
            <input type="file" accept="image/*" class="form-control" id="profilePhoto" name="profile_picture" style="max-width: 50%;">
        </div>
        <small class="text-muted d-block mt-2"><i class="fa-solid fa-file-circle-plus me-1"></i>Maximum size: 2 mb</small>
        <small class="text-muted d-block mt-2"><i class="fa-solid fa-up-right-and-down-left-from-center me-1"></i>Minimum dimension: 300x300</small>
    </div>
    <div class="my-3">
      <div class="cf-turnstile" data-sitekey="0x4AAAAAAAN8p0y-GxgH2k2X" {% if is_mobile %}data-size="compact"{% endif %} data-theme="{{ request.cookies.get('theme', 'light') }}" data-callback="onCaptchaSuccess"></div>
    </div>
    <p id="captchaMessage" class="mb-2 small">
      <i class="fa-solid fa-robot me-2"></i>Please complete the captcha to enable the submit button.
    </p>
    <button class="btn btn btn-secondary" type="submit" id="captchaSubmitButton" disabled>Submit</button>
</form>
{% endblock %}
{% block scripts %}
<script nonce="{{ nonce }}" src="{{ url_for('static', filename='js/libs/cropper.min.js') }}"></script>
<script nonce="{{ nonce }}">
let cropper;  // Global cropper instance
let currentInputId;  // To track which input is currently being edited

function initializeCropper(input, previewElement, isBackground) {
    const file = input.files[0];
    const img = document.createElement('img');
    
    const reader = new FileReader();
    reader.onload = function (e) {
        img.src = e.target.result;
        img.style.maxWidth = "100%";
        img.style.maxHeight = "400px";
        
        // Destroy any existing cropper instance
        if (cropper) {
            cropper.destroy();
        }

        // Display the image on the page for cropping
        previewElement.innerHTML = '';  // Clear any existing image
        previewElement.appendChild(img);
        cropper = new Cropper(img, {
            aspectRatio: isBackground ? 16 / 9 : 1,
            viewMode: 1,
        });
    };
    reader.readAsDataURL(file);
}

function updatePreviewElements(croppedDataUrl) {
    // Different previews depending on which image is being cropped
    if (currentInputId === 'backgroundImage') {
        document.getElementById('profileBackground').style.backgroundImage = 'url(' + croppedDataUrl + ')';
    } else if (currentInputId === 'bannerImage') {
        document.getElementById('profileHeader').style.backgroundImage = 'url(' + croppedDataUrl + ')';
    } else if (currentInputId === 'profilePhoto') {
        const largeAvatar = document.getElementById('largeAvatar');
        const mediumAvatar = document.getElementById('mediumAvatar');
        const smallAvatar = document.getElementById('smallAvatar');

        if (largeAvatar) largeAvatar.src = croppedDataUrl;
        if (mediumAvatar) mediumAvatar.src = croppedDataUrl;
        if (smallAvatar) smallAvatar.src = croppedDataUrl;
    }
}

document.getElementById('backgroundImage').addEventListener('change', function () {
    currentInputId = 'backgroundImage';
    initializeCropper(this, document.getElementById('profileBackground'), true);
});

document.getElementById('bannerImage').addEventListener('change', function () {
    currentInputId = 'bannerImage';
    initializeCropper(this, document.getElementById('profileHeader'), true);
});

document.getElementById('profilePhoto').addEventListener('change', function () {
    currentInputId = 'profilePhoto';
    initializeCropper(this, document.getElementById('largeAvatar').parentNode, false);
});

async function cropAndSubmit(form) {
    if (cropper) {
        const croppedCanvas = cropper.getCroppedCanvas();
        const croppedBlob = await new Promise((resolve) => croppedCanvas.toBlob(resolve, 'image/jpeg'));

        // Create a new File from the Blob with the same name as the original file
        const croppedFile = new File([croppedBlob], `${currentInputId}.jpg`, {
            type: 'image/jpeg',
            lastModified: Date.now(),
        });

        // Replace the file input with the cropped file
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(croppedFile);

        const inputElement = document.getElementById(currentInputId);
        inputElement.files = dataTransfer.files; // Update input files with cropped file

        // Update the preview elements with the cropped data
        updatePreviewElements(croppedCanvas.toDataURL('image/jpeg'));

        // Cleanup
        cropper.destroy();
        cropper = null;
    }

    form.submit();  // Submit the form with the updated file input
}

// Attach cropAndSubmit to the form submission event
document.getElementById('captcha-wait-form').addEventListener('submit', function (event) {
    event.preventDefault();  // Prevent default submission
    cropAndSubmit(this);  // Perform cropping, replace file input, and submit
});

</script>
{% endblock %}
