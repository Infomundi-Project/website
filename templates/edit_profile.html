{% extends "base.html" %}

{% block title %}Edit Profile{% endblock %}

{% block edit_profile_content %}
<h3>General</h3>
<hr>
<form method="post" action="{{ url_for('views.edit_user_profile', username=current_user.username) }}">
   <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
   <div class="mb-3">
      <div class="input-group mb-3">
         <span class="input-group-text"><i class="fa-solid fa-user"></i></span>
         <div class="form-floating">
            <input type="text" name="display_name" class="form-control" id="floatingInputDisplayName" placeholder="Display Name" value="{{ current_user.display_name }}" maxlength="40">
            <label for="floatingInputDisplayName">Display Name</label>
         </div>
      </div>
   </div>
   <div class="input-group mb-3">
      <span class="input-group-text">@</span>
      <div class="form-floating">
         <input type="text" name="username" class="form-control" id="floatingInputGroup1" placeholder="Username" value="{{ current_user.username }}">
         <label for="floatingInputGroup1">Username</label>
      </div>
   </div>
   <div class="mb-3">
      <div class="form-floating">
         <textarea name="description" class="form-control" placeholder="Add a description to your profile" id="floatingTextarea" style="height: 200px" maxlength="1500">{% if current_user.profile_description %}{{ current_user.profile_description }}{% endif %}</textarea>
         <label for="floatingTextarea">Description</label>
      </div>
   </div>
   <h4 class="mt-5">Localization</h4>
   <hr>
   <div>
          <div class="mb-3">
              <label for="country" class="form-label">Country</label>
              <select id="country" class="form-select form-select-lg" aria-label="Select Country">
                  <option selected disabled>Select your country</option>
              </select>
          </div>
          <div class="mb-3 d-none" id="state-div">
              <label for="state" class="form-label">State</label>
              <select id="state" class="form-select form-select-lg" aria-label="Select State">
                  <option selected disabled>Select your state</option>
              </select>
          </div>
          <div class="mb-3 d-none" id="city-div">
              <label for="city" class="form-label">City</label>
              <select id="city" class="form-select form-select-lg" aria-label="Select City">
                  <option selected disabled>Select your city</option>
              </select>
          </div>
  </div>
  <div class="mt-5">
      <div class="cf-turnstile" data-sitekey="0x4AAAAAAAN8p0y-GxgH2k2X" data-theme="{{ request.cookies.get('theme', 'light') }}"></div>
      <button type="submit" class="btn btn-primary"><i class="fa-solid fa-floppy-disk me-1"></i>Save</button>
   </div>
</form>
{% endblock %}
{% block scripts %}
<script nonce="{{ nonce }}">
   $(document).ready(function() {
       // Fetch countries on page load
       $.ajax({
           url: 'https://infomundi.net/api/countries',
           method: 'GET',
           success: function(data) {
               let countries = data;
               let countrySelect = $('#country');
               countries.forEach(function(country) {
                   countrySelect.append(new Option(country.name, country.id));
               });
           },
           error: function(error) {
               console.error('Error fetching countries:', error);
           }
       });

       // Fetch states when a country is selected
       $('#country').change(function() {
           let countryId = $(this).val();
           if (countryId) {
               $.ajax({
                   url: `https://infomundi.net/api/countries/${countryId}/states`,
                   method: 'GET',
                   success: function(data) {
                       let states = data;
                       let stateSelect = $('#state');
                       stateSelect.empty().append(new Option('Select your state', ''));
                       states.forEach(function(state) {
                           stateSelect.append(new Option(state.name, state.id));
                       });
                       $('#state-div').removeClass('d-none');
                   },
                   error: function(error) {
                       console.error('Error fetching states:', error);
                   }
               });
           }
       });

       // Fetch cities when a state is selected
       $('#state').change(function() {
           let stateId = $(this).val();
           if (stateId) {
               $.ajax({
                   url: `https://infomundi.net/api/states/${stateId}/cities`,
                   method: 'GET',
                   success: function(data) {
                       let cities = data;
                       let citySelect = $('#city');
                       citySelect.empty().append(new Option('Select your city', ''));
                       cities.forEach(function(city) {
                           citySelect.append(new Option(city.name, city.id));
                       });
                       $('#city-div').removeClass('d-none');
                   },
                   error: function(error) {
                       console.error('Error fetching cities:', error);
                   }
               });
           }
       });
   });
</script>
{% endblock %}