{% extends "base.html" %}
{% block title %}Dashboard Home{% endblock %}

{% block styles %}
<style>
  .top-stories-container { cursor: grab; }
.top-stories-container.dragging { cursor: grabbing; }

  /* Minimal overrides; everything else uses Bootstrap utilities */
  #chartdiv {
    width: 100%;
    height: 500px;
  }
  @media (max-width: 768px) {
    #chartdiv {
      height: 300px;
    }
  }
  /* Keep metric cards uniform height */
  .metric-card {
    min-height: 8rem;
  }
  /* Horizontal scroll container for Top Stories */
  .top-stories-container {
    display: flex;
    flex-direction: row;
    gap: 1rem;
    overflow-x: auto;
    padding-bottom: 0.5rem;
  }
  /* Hide default scrollbar on WebKit (Chrome/Safari) */
  .top-stories-container::-webkit-scrollbar {
    display: none;
  }
  /* Hide default scrollbar on Firefox */
  .top-stories-container {
    scrollbar-width: none;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <!-- 1) TOP BAR / SEARCH -->
  <div class="row justify-content-center">
    <div class="col-12 col-md-8 col-lg-6">
      <form action="{{ url_for('api.search') }}" method="POST">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        <div class="input-group input-group-lg">
          <span
            class="input-group-text {% if is_light_mode %}bg-white border- {% else %}bg-dark text-white{% endif %}"
            id="search-icon"
          >
            <i class="fa-solid fa-magnifying-glass"></i>
          </span>
          <input
            type="search"
            class="form-control {% if is_light_mode %}border- {% endif %}"
            id="query"
            name="query"
            placeholder="Search for a country..."
            aria-label="Search for a country"
            aria-describedby="search-icon"
            minlength="3"
          >
        </div>
      </form>
    </div>
  </div>

    <!-- 4) GLOBE & METRICS -->
  <div class="row my-3">
    <!-- 4a) LEFT: Globe (country selector) -->
    <div class="col-12 col-lg-8">
      <div class="card shadow-sm h-100">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fa-solid fa-earth-americas me-2"></i>Select a Country
          </h5>
        </div>
        <div class="card-body p-0">
          <div id="chartdiv"></div>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-4">
    <div class="row row-cols-2">
      <div class="col mb-2">
        <div class="card metric-card shadow-sm text-center">
          <div class="card-body d-flex flex-column justify-content-center">
            <i class="fa-solid fa-globe fa-2x mb-2 text-primary"></i>
            <h5 class="card-title">Countries</h5>
            <p class="card-text display-6 mb-0">{{ statistics['total_countries_supported'] }}</p>
          </div>
        </div>
      </div>
      <div class="col mb-2">
        <div class="card metric-card shadow-sm text-center">
          <div class="card-body d-flex flex-column justify-content-center">
            <i class="fa-solid fa-newspaper fa-2x mb-2 text-success"></i>
            <h5 class="card-title">News</h5>
            <p class="card-text display-6 mb-0">{{ statistics['total_news'] }}</p>
          </div>
        </div>
      </div>
      <div class="col mb-2">
        <div class="card metric-card shadow-sm text-center">
          <div class="card-body d-flex flex-column justify-content-center">
            <i class="fa-solid fa-users fa-2x mb-2 text-warning"></i>
            <h5 class="card-title">Users</h5>
            <p class="card-text display-6 mb-0">{{ statistics['total_users'] }}</p>
          </div>
        </div>
      </div>
    </div>
  </div>


  </div>

  <!-- Top Stories -->
  <div class="row g-3 mb-4">
    <div class="col-12 col-lg-4">
      <div class="card shadow-sm">
        <div class="card-header">
          <h6 class="mb-0">
            <i class="fa-solid fa-fire text-danger me-2"></i>Top Stories
          </h6>
        </div>
        <div class="card-body">
          <!-- Single‐row, horizontally scrollable container -->
          <div id="topStoriesContainer" class="top-stories-container">
            <!-- JavaScript will inject each story card (fixed‐width) here -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 3) DASHBOARD ROW -->
  <div class="row gy-4">
    <!-- 3a) LEFT: LINE CHART -->
    <div class="col-12 col-lg-8">
      <div class="card shadow-sm h-100">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fa-solid fa-chart-line me-2"></i>Stories Published (Last 7 Days)
          </h5>
        </div>
        <div class="card-body">
          <canvas id="storiesLineChart" width="100%" height="60"></canvas>
        </div>
      </div>
    </div>

    <!-- 3b) RIGHT: BAR + DONUT CHART -->
    <div class="col-12 col-lg-4 d-flex flex-column gap-4">
      <div class="card shadow-sm">
        <div class="card-header">
          <h6 class="mb-0">
            <i class="fa-solid fa-bars-staggered me-2"></i>Top Countries (This Week)
          </h6>
        </div>
        <div class="card-body">
          <canvas id="categoriesBarChart" width="100%" height="50"></canvas>
        </div>
      </div>
      <div class="card shadow-sm">
        <div class="card-header">
          <h6 class="mb-0">
            <i class="fa-solid fa-chart-pie me-2"></i>User Engagement
          </h6>
        </div>
        <div class="card-body d-flex justify-content-center">
          <canvas id="engagementDoughnut" width="100%" height="100"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block scripts %}
  <script defer nonce="{{ nonce }}" src="{{ url_for('static', filename='js/amcharts/index.js') }}"></script>
  {% if not is_mobile %}
    <script defer nonce="{{ nonce }}" src="{{ url_for('static', filename='js/fetchHomeTicker.js') }}"></script>
  {% endif %}
  {% assets "js_home" %}
    <script defer nonce="{{ nonce }}" type="text/javascript" src="{{ ASSET_URL }}"></script>
  {% endassets %}

<script nonce="{{ nonce }}">
document.addEventListener("DOMContentLoaded", function() {
  // ── 1) STORIES LINE CHART ──
  const ctxLine = document.getElementById("storiesLineChart").getContext("2d");
  const storiesChart = new Chart(ctxLine, {
    type: 'line',
    data: {
      labels: [],            // ← filled from API
      datasets: [{
        label: 'Stories',
        data: [],            // ← filled from API
        fill: false,
        borderColor: 'rgba(75, 192, 192, 1)',
        tension: 0.1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: {
          type: 'category',
          grid: { display: false }
        },
        y: {
          beginAtZero: true
        }
      },
      plugins: {
        legend: { display: false }
      }
    }
  });

  // ── 2) TOP COUNTRIES BAR CHART ──
  const ctxBar = document.getElementById("categoriesBarChart").getContext("2d");
  const countriesChart = new Chart(ctxBar, {
    type: 'bar',
    data: {
      labels: [],
      datasets: [{
        label: '# of Stories',
        data: [],
        backgroundColor: [
          'rgba(255, 99, 132, 0.6)',
          'rgba(54, 162, 235, 0.6)',
          'rgba(255, 206, 86, 0.6)',
          'rgba(75, 192, 192, 0.6)',
          'rgba(153, 102, 255, 0.6)'
        ],
        borderColor: [
          'rgba(255, 99, 132, 1)',
          'rgba(54, 162, 235, 1)',
          'rgba(255, 206, 86, 1)',
          'rgba(75, 192, 192, 1)',
          'rgba(153, 102, 255, 1)'
        ],
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      indexAxis: 'y',
      scales: {
        x: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' } },
        y: { grid: { display: false } }
      },
      plugins: { legend: { display: false } }
    }
  });

  // ── 3) USER ENGAGEMENT DOUGHNUT ──
  const ctxDoughnut = document.getElementById("engagementDoughnut").getContext("2d");
  const engagementChart = new Chart(ctxDoughnut, {
    type: 'doughnut',
    data: {
      labels: ['Likes', 'Dislikes', 'Comments', 'Shares'],
      datasets: [{
        data: [],
        backgroundColor: [
          'rgba(75, 192, 192, 0.7)',
          'rgba(255, 99, 132, 0.7)',
          'rgba(255, 206, 86, 0.7)',
          'rgba(54, 162, 235, 0.7)'
        ],
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '60%',
      plugins: {
        legend: {
          position: 'bottom',
          labels: { boxWidth: 12, padding: 16 }
        }
      }
    }
  });

  // ── 4) FETCH DASHBOARD DATA ──
  fetch("/api/home/dashboard")
    .then(res => {
      if (!res.ok) throw new Error("Failed to load dashboard data");
      return res.json();
    })
    .then(json => {
      // update line chart
      storiesChart.data.labels = json.days.map(d => {
        const dt = new Date(d);
        return dt.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
      });
      storiesChart.data.datasets[0].data = json.stories_last_7_days;
      storiesChart.update();

      // update bar chart (top countries)
      countriesChart.data.labels = json.top_countries.map(c => c.country);
      countriesChart.data.datasets[0].data = json.top_countries.map(c => c.count);
      countriesChart.update();

      // update doughnut (engagement)
      const e = json.engagement;
      engagementChart.data.datasets[0].data = [e.likes, e.dislikes, e.comments, e.shares];
      engagementChart.update();
    })
    .catch(err => console.error("Could not load dashboard data:", err));

  // ── 5) TRENDING: GLOBE & TOP STORIES ──
  const topStoriesContainer = document.getElementById("topStoriesContainer");
  if (topStoriesContainer) {
    fetch("/api/home/trending")
      .then(res => res.ok ? res.json() : Promise.reject("Failed to fetch top stories"))
      .then(stories => {
        stories.forEach(story => {
          const {
            story_id, title, pub_date, image_url,
            publisher, views, likes, dislikes, num_comments, description=""
          } = story;

          // time-ago
          const then = new Date(pub_date), now = new Date();
          const diffHours = Math.floor((now - then) / 36e5);
          const diffDays  = Math.floor(diffHours / 24);
          const timeAgo   = diffHours < 24 ? `${diffHours}h ago` : `${diffDays}d ago`;

          // sanitize
          const desc = description
            .replace(/&/g, "&amp;")
            .replace(/"/g, "&quot;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;");

          // card wrapper
          const wrapper = document.createElement("div");
          wrapper.className = "flex-shrink-0";
          wrapper.style.width = "15rem";
          wrapper.innerHTML = `
            <div class="card h-100 shadow-sm position-relative mb-2" id="${story_id}">
              <a href="/comments?id=${story_id}">
                <img src="${image_url}"
                     class="card-img-top rounded-top"
                     alt="${title.replace(/"/g,"&quot;")}"
                     style="aspect-ratio:16/9; object-fit:cover;"
                     draggable="false">
              </a>
              <div class="position-absolute top-0 end-0 mt-2 me-2">
                <span data-bs-toggle="tooltip" data-bs-title="Source: ${publisher.name}">
                  ${publisher.favicon_url ? 
            `<img src="${publisher.favicon_url}" class="rounded" alt="${item.publisher.name} favicon image" width="30">` : 
            `<i class="fa-solid fa-tower-cell"></i>`
          }
                </span>
              </div>
              <div class="card-body">
                <h6 class="card-title fw-semibold line-clamp-2">${title}</h6>
                <p class="card-text text-muted small line-clamp-3">${desc}</p>
                <p class="card-text"><small class="text-secondary">${timeAgo}</small></p>
              </div>
            </div>`;
          topStoriesContainer.appendChild(wrapper);
        });

        // init tooltips
        Array.from(topStoriesContainer.querySelectorAll("[data-bs-toggle='tooltip']"))
             .forEach(el => new bootstrap.Tooltip(el));
      })
      .catch(err => console.error("Error loading top stories:", err));

    // ── drag to scroll ──
    let isDown = false, startX = 0, scrollStart = 0;
    topStoriesContainer.addEventListener("mousedown", e => {
      isDown = true;
      topStoriesContainer.classList.add("dragging");
      startX = e.pageX - topStoriesContainer.offsetLeft;
      scrollStart = topStoriesContainer.scrollLeft;
      e.preventDefault();
    });
    ['mouseleave','mouseup'].forEach(evt => {
      topStoriesContainer.addEventListener(evt, () => {
        isDown = false;
        topStoriesContainer.classList.remove("dragging");
      });
    });
    topStoriesContainer.addEventListener("mousemove", e => {
      if (!isDown) return;
      e.preventDefault();
      const x = e.pageX - topStoriesContainer.offsetLeft;
      topStoriesContainer.scrollLeft = scrollStart - (x - startX);
    });
    topStoriesContainer.addEventListener("dragstart", e => e.preventDefault());
  }
});
</script>
{% endblock %}

