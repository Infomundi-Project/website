{% extends "base.html" %} {% block title %}{{ seo_data[0] }}{% endblock %}

{% block header %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/comments.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/maximusSummary.css') }}">
<meta name="csrf-token" content="{{ csrf_token() }}">
{% endblock %}

{% block content %}
<div class="container align-items-center mt-5">
   <nav aria-label="breadcrumb" style="--bs-breadcrumb-divider: '-';">
      <ol class="breadcrumb">
         <li class="breadcrumb-item"><a href="{{ url_for('views.home') }}">Home</a></li>
         <li class="breadcrumb-item"><a href="{{ from_country_url }}">{{ from_country_name }} {{ from_country_category.title() }}</a></li>
         <li class="breadcrumb-item active" aria-current="page"><small>{{ ' '.join(story.title.split(' ')[:5]) }}...</small></li>
      </ol>
   </nav>
   <h1 class="fw-bold mt-3 mb-3 text-uppercase">{{ story.title }}</h1>
   <p class="text-body-secondary small">Published by <a href="{{ story.link }}" target="_blank">{{ story.publisher.name }}</a>, on {{ story.pub_date }}<span class="ms-1">&#x2022;</span><span class="ms-1">{{ story.stats.views }} view{% if story.stats.views > 1 or story.stats.views == 0 %}s{% endif %}</span></p>
   
   <div class="my-5 d-flex justify-content-center inf-image-wrapper">
      <img fetchpriority="high" src="{{ story.image_url }}" class="story-img" alt="The image for this story">
   </div>

   <h2 class="fs-6 fw-light">{{ story.description|safe }}</h2>
   <hr class="mt-5 mb-3">
   <div class="maximus">
              <!-- Header Section -->
              <div class="maximus-summary-header row align-items-start">
                <div class="col-auto mt-2">
                  <img src="{{ url_for('static', filename='img/illustrations/maximus.webp') }}" alt="Profile Picture" class="border border-3 p-2">
                </div>
                <div class="col-md-10">
                  <span class="fs-3">MAXIMUS</span><span class="ms-3 small text-uppercase">Infomundi's AI</span>
                  <div class="my-3 border rounded">
                    <p class="p-3 m-0">Hi, my name is Maximus, and I'm Infomundi's AI. My job is to help you make sense of complex stories and ideas. Here's how I work:</p>
                      <ul class="p-3 m-0 ms-3">
                        <li><strong>Addressed Topics:</strong> I'll highlight the key themes and main ideas for you.</li>
                        <li><strong>Context Around:</strong> I'll provide the background and connect the dots so you get the full picture.</li>
                        <li><strong>Methods for Investigation:</strong> I'll suggest ways to explore further, like useful resources and actionable tools.</li>
                        <li><strong>Questioning the Subject:</strong> I'll help you critically analyze key questions about the subject.</li>
                      </ul>
                      <p class="p-3 m-0">Think of me as your guide to turning bulk information into clear and actionable insights.</p>
                  </div>
                </div>
              </div>
              <!-- Content Section -->
              <div class="maximus-summary-content-placeholder">
                <!-- Blurred Text -->
                <p class="maximus-summary-blurred-text text-break" id="maximusSummaryBlurredText"></p>
                <!-- Progress Bar -->
                <div class="maximus-summary-progress">
                  <div class="progress-bar progress-bar-striped bg-primary" role="progressbar" style="width: 0%;" id="maximusSummaryProgressBar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
              </div>
              <div class="maximus-summary-api-response"></div>
            </div>




   <div class="container mt-5">
    <h3 class="mb-4">Comments</h3>

    <!-- Comment Form -->
    <!--
    <form id="commentForm" class="mb-4">
      <div class="mb-3">
        <textarea class="form-control" id="commentText" rows="3" placeholder="Write your comment..." required></textarea>
      </div>
      <input type="hidden" id="parentId" />
      <button type="submit" class="btn btn-primary">Post Comment</button>
    </form>-->

    <form id="commentForm" class="mb-4">
      <div class="d-flex align-items-start gap-2">
        <img src="{{ current_user.avatar_url }}" alt="User" class="rounded me-2" width="48" height="48">
        <textarea id="commentText" class="form-control flex-grow-1" rows="4" placeholder="Write your thoughts..."></textarea>
      </div>
      <div class="d-flex justify-content-end mt-2">
        <button type="submit" class="btn btn-primary">Post</button>
      </div>
      <input type="hidden" id="parentId" name="parentId">
    </form>


    <!-- Comments List -->
    <div id="commentsList"></div>
  </div>




   <div class="container mt-5">
      <nav aria-label="breadcrumb" style="--bs-breadcrumb-divider: '-';">
         <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('views.home') }}">Home</a></li>
            <li class="breadcrumb-item"><a href="{{ from_country_url }}">{{ from_country_name }} {{ from_country_category.title() }}</a></li>
            <li class="breadcrumb-item active" aria-current="page"><small>{{ ' '.join(story.title.split(' ')[:5]) }}...</small></li>
         </ol>
      </nav>
   </div>
   <!-- Return button -->
   {% if is_mobile %}
   <a type="button" class="btn btn-primary btn-sm inf-fixed-button invisible" href="{{ from_country_url }}" id="commentsReturnButtonMobile" style="position: fixed; top: 12vh; left: 20px;">
   <i class="fa-solid fa-rotate-left me-1"></i>{{ from_country_name }} {{ from_country_category.title() }}
   </a>
   {% else %}
   <a type="button" class="btn btn-primary btn-sm inf-fixed-button" href="{{ from_country_url }}" id="commentsReturnButton" style="position: fixed; top: 12vh; left: 20px;">
   <i class="fa-solid fa-rotate-left me-1"></i>{{ from_country_name }} {{ from_country_category.title() }}
   </a>
   {% endif %}
</div>
{% endblock %}




{% block scripts %}
<script nonce="{{ nonce }}" src="{{ url_for('static', filename='js/maximusSummary.js') }}"></script>
<script nonce="{{ nonce }}">
const urlParams = new URLSearchParams(window.location.search);
const story_id = urlParams.get('id');

fetchAndRenderStorySummary(story_id);
</script>

  <script nonce="{{ nonce }}">
    const form = document.getElementById('commentForm');
    const commentText = document.getElementById('commentText');
    const parentIdField = document.getElementById('parentId');
    const commentsList = document.getElementById('commentsList');
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    async function loadComments() {
      const res = await fetch(`/api/comments/story/${story_id}`);
      const data = await res.json();
      commentsList.innerHTML = '';
      data.forEach(comment => renderComment(comment, commentsList));
    }

    function renderComment(comment, container, level = 0) {
  const div = document.createElement('div');
  div.className = 'card mb-3 shadow-sm' + (level ? ' ms-5 border-start ps-3' : '');
  div.dataset.id = comment.id;

  const repliesContainerId = `replies-${comment.id}`;
  const editedTag = comment.is_edited ? `<span class="text-muted ms-2 fst-italic">(edited)</span>` : '';

  div.innerHTML = `
    <div class="card-body">
      <div class="d-flex align-items-start">
        <img src="${comment.user.avatar_url}" class="rounded me-3" alt="User Avatar" width="48" height="48">
        <div class="w-100">
          <div class="d-flex justify-content-between">
            <div>
              <strong>${comment.user.username || 'Anonymous'}</strong>
              ${comment.user.role ? `<span class="badge bg-primary ms-2">${comment.user.role}</span>` : ''}<br>
              <small class="text-muted">Posted on ${new Date(comment.created_at).toLocaleString()}</small>
              ${editedTag}
            </div>
            <div class="dropdown">
              <button class="btn btn-sm btn-light" type="button" data-bs-toggle="dropdown">
                <i class="fa-solid fa-ellipsis-vertical"></i>
              </button>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item edit-btn" href="#">Edit</a></li>
                <li><a class="dropdown-item delete-btn text-danger" href="#">Delete</a></li>
              </ul>
            </div>
          </div>

          <p class="mt-3 mb-2" id="comment-content-${comment.id}">
            ${comment.content}
          </p>

          <div class="d-flex align-items-center mt-3">
            <button class="btn btn-sm btn-outline-primary like-btn me-2">
              <i class="fa-solid fa-thumbs-up"></i> <span class="badge bg-primary">${comment.likes}</span>
            </button>
            <button class="btn btn-sm btn-outline-danger dislike-btn me-2">
              <i class="fa-solid fa-thumbs-down"></i> <span class="badge bg-danger">${comment.dislikes}</span>
            </button>
            <button class="btn btn-sm btn-outline-secondary reply-btn">
              <i class="fa-solid fa-reply"></i> Reply
            </button>
          </div>

          <div id="${repliesContainerId}" class="mt-4"></div>
        </div>
      </div>
    </div>
  `;

  // Attach actions
  const likeBtn = div.querySelector('.like-btn');
  const dislikeBtn = div.querySelector('.dislike-btn');
  const replyBtn = div.querySelector('.reply-btn');
  const editBtn = div.querySelector('.edit-btn');
  const deleteBtn = div.querySelector('.delete-btn');

  likeBtn.addEventListener('click', () => likeComment(comment.id));
  dislikeBtn.addEventListener('click', () => dislikeComment(comment.id));
  replyBtn.addEventListener('click', () => replyTo(comment.id));
  editBtn.addEventListener('click', (e) => {
    e.preventDefault();
    editComment(comment.id);
  });
  deleteBtn.addEventListener('click', (e) => {
    e.preventDefault();
    deleteComment(comment.id);
  });

  container.appendChild(div);

  // Render replies recursively
  if (comment.replies && comment.replies.length) {
    const repliesContainer = div.querySelector(`#${repliesContainerId}`);
    comment.replies.forEach(reply => renderComment(reply, repliesContainer, level + 1));
  }
}



    form.addEventListener('submit', async function(e) {
      e.preventDefault();
      const content = commentText.value.trim();
      const parent_id = parentIdField.value || null;
      if (!content) return;

      const res = await fetch('/api/comments', {
        method: 'POST',
        headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken 
        },
        body: JSON.stringify({ content, parent_id, story_id })
      });

      if (res.ok) {
        commentText.value = '';
        parentIdField.value = '';
        await loadComments();
      }
    });

    async function likeComment(id) {
      await fetch(`/api/comments/${id}/like`, { method: 'POST',
        headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken 
        } });
      loadComments();
    }

    async function dislikeComment(id) {
      await fetch(`/api/comments/${id}/dislike`, { method: 'POST',
        headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken 
        } });
      loadComments();
    }

    function replyTo(id) {
      parentIdField.value = id;
      commentText.focus();
    }

    function editComment(id) {
      const contentDiv = document.getElementById(`comment-content-${id}`);
      const originalText = contentDiv.innerText.trim();
      const textarea = document.createElement('textarea');
      textarea.className = 'form-control mb-2';
      textarea.value = originalText;

      const saveBtn = document.createElement('button');
      saveBtn.className = 'btn btn-sm btn-success me-2';
      saveBtn.textContent = 'Save';

      const cancelBtn = document.createElement('button');
      cancelBtn.className = 'btn btn-sm btn-secondary';
      cancelBtn.textContent = 'Cancel';

      contentDiv.replaceWith(textarea);
      textarea.after(saveBtn, cancelBtn);

      saveBtn.onclick = async () => {
        const updatedText = textarea.value.trim();
        if (!updatedText) return;
        await fetch(`/api/comments/${id}`, {
          method: 'PUT',
        headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken 
        },
          body: JSON.stringify({ content: updatedText })
        });
        loadComments();
      };

      cancelBtn.onclick = () => loadComments();
    }

    async function deleteComment(id) {
      if (confirm("Are you sure you want to delete this comment?")) {
        await fetch(`/api/comments/${id}`, { method: 'DELETE',
        headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken 
        } });
        loadComments();
      }
    }

    // Load comments on page load
    loadComments();
  </script>





<script nonce="{{ nonce }}"
      src="{{ url_for('static', filename='js/scrollProgressBar.js') }}" 
      ></script>

<script type="application/ld+json" nonce="{{ nonce }}">
   {
     "@context": "https://schema.org",
     "@type": "Article",
     "headline": "{{ story.title }}",
     "description": "{{ story.description }}",
     "image": "{{ story.image_url }}",
     "publisher": {
       "@type": "Organization",
       "name": "{{ story.publisher.name }}",
       "logo": {
         "@type": "ImageObject",
         "url": "{{ story.publisher.favicon_url }}"
       }
     },
     "mainEntityOfPage": {
       "@type": "WebPage",
       "@id": "{{ request.url }}"
     }
   }
</script>
{% endblock %}