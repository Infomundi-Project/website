$(document).ready(function(){loadComments();$('#sort-comments').change(function(){loadComments();});$('#cooldown-button').click(function(){submitComment();});$('#comments-section').on('click','.like-btn',function(){handleLikeDislikeReport($(this).data('commentId'),'like');});$('#comments-section').on('click','.dislike-btn',function(){handleLikeDislikeReport($(this).data('commentId'),'dislike');});$('#comments-section').on('click','.reply-btn',function(){showReplyBox($(this).data('commentId'));});$('#comments-section').on('click','.report-btn',function(){handleLikeDislikeReport($(this).data('commentId'),'report');});$('#comments-section').on('click','.submit-reply',function(){submitReply($(this).data('parentId'));});$('#comments-section').on('click','.view-more-replies',function(){loadReplies($(this).data('commentId'));});});function loadComments(){var sortBy=$('#sort-comments').val();$.ajax({url:'/api/comments',type:'GET',data:{sort:sortBy},success:function(data){$('#total-comments').text(`${data.total}`);renderComments(data.comments);}});}
function renderComments(comments,parentId=null){comments=Array.isArray(comments)?comments:[];if(!parentId){$('#comments-list').empty();}
comments.forEach(function(comment){var roleTag='';if(comment.userRole){var badgeClass='bg-secondary';if(comment.userRole==='admin'){badgeClass='bg-danger';roleTag=`<span class="badge ${badgeClass} ms-2">${comment.userRole}</span>`;}else if(comment.userRole==='moderator'){badgeClass='bg-success';}else if(comment.userRole==='subscriber'){badgeClass='bg-info';}}
var commentHtml=`<div class="list-group-item ${parentId ? 'ms-3' : ''}"id="comment-${comment.id}"><div class="d-flex w-100 justify-content-between"><div class="d-flex align-items-center"><img src="${comment.userAvatar}"alt="${comment.userName}'s Avatar"class="rounded-circle me-2"style="width: 38px; height: 38px;"><h5 class="mb-1">${comment.userName}${roleTag}</h5></div><small>${timeSince(new Date(comment.timestamp))}</small></div><p class="mb-1"style="word-wrap: break-word;">${comment.text}</p><div><button class="btn btn-outline-primary btn-sm like-btn"data-comment-id="${comment.id}"><i class="fa-solid fa-circle-up me-1"></i>${comment.likes}</button><button class="btn btn-outline-secondary btn-sm dislike-btn ms-1"data-comment-id="${comment.id}"><i class="fa-solid fa-circle-down me-1"></i>${comment.dislikes}</button><button class="btn btn-outline-info btn-sm reply-btn ms-1"data-comment-id="${comment.id}"><i class="fa-solid fa-reply"></i></button><button class="btn btn-outline-danger btn-sm report-btn ms-3"data-comment-id="${comment.id}"><i class="fa-solid fa-flag"></i></button></div></div>`;if(parentId){$(`#comment-${parentId}.replies`).append(commentHtml);}else{$('#comments-list').append(commentHtml);}
if(comment.replies&&comment.replies.length>0){if(!$(`#comment-${comment.id}.replies`).length){$(`#comment-${comment.id}`).append('<div class="replies list-group mt-2"></div>');}
renderComments(comment.replies,comment.id);}});}
function submitComment(){var commentText=$('#new-comment').val().trim();if(commentText){$.ajax({url:'/api/comments',type:'POST',data:JSON.stringify({text:commentText}),contentType:'application/json; charset=utf-8',success:function(){$('#new-comment').val('');loadComments();start_countdown('cooldown-button',7);}});}else{alert('Please enter a comment before submitting.');}}
function handleLikeDislikeReport(commentId,action){$.ajax({url:`/api/comments/${commentId}/${action}`,type:'POST',success:function(response){if(action==='report'){alert(response.message);}
loadComments();},error:function(response){alert(response.message);}});}
function showReplyBox(commentId){$('.reply-box').remove();var replyBoxHtml=`<div class="reply-box mt-2"><form class="d-flex flex-column"><textarea class="form-control mb-2 reply-text"placeholder="Write a reply..."></textarea><div class="d-flex justify-content-end"><button type="button"class="btn btn-secondary me-2 cancel-reply">Cancel</button><button type="button"class="btn btn-primary submit-reply"id="submit-reply"data-parent-id="${commentId}">Reply</button></div></form></div>`;$(`#comment-${commentId}`).append(replyBoxHtml);$('.cancel-reply').click(function(){$(this).closest('.reply-box').remove();});}
function submitReply(parentId){var replyText=$(`#comment-${parentId}.reply-text`).val().trim();if(replyText){$.ajax({url:'/api/comments',type:'POST',data:JSON.stringify({text:replyText,parentId:parentId}),contentType:'application/json; charset=utf-8',success:function(){loadComments();start_countdown('submit-reply',5);},error:function(response){alert(response.message);}});}else{alert('Please enter a reply before submitting.');}}
function loadReplies(commentId){$.ajax({url:`/api/comments/${commentId}/replies`,type:'GET',success:function(data){renderComments(data.replies,commentId);}});}
function timeSince(date){var seconds=Math.floor((new Date()-date)/1000);var interval=seconds/31536000;if(interval>1){return Math.floor(interval)+" years ago";}
interval=seconds/2592000;if(interval>1){return Math.floor(interval)+" months ago";}
interval=seconds/86400;if(interval>1){return Math.floor(interval)+" days ago";}
interval=seconds/3600;if(interval>1){return Math.floor(interval)+" hours ago";}
interval=seconds/60;if(interval>1){return Math.floor(interval)+" minutes ago";}
return Math.floor(seconds)+" seconds ago";}
function start_countdown(buttonId,cooldownTime){const cooldownButton=document.getElementById(buttonId);if(!cooldownButton){return;}
let timeLeft=cooldownTime;function updateCountdown(){if(timeLeft>0){cooldownButton.innerHTML=`Cooldown:<span id="timer-${buttonId}">${timeLeft}</span>seconds`;cooldownButton.setAttribute("disabled","true");cooldownButton.classList.add("btn-secondary");cooldownButton.classList.remove("btn-primary");timeLeft--;setTimeout(updateCountdown,1000);}else{cooldownButton.innerHTML='Comment';cooldownButton.removeAttribute("disabled");cooldownButton.classList.remove("btn-secondary");cooldownButton.classList.add("btn-primary");}}
updateCountdown();}
start_countdown('cooldown-button',7);